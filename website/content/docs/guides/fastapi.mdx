---
title: FastAPI Integration
description: Complete guide to integrating APoP into a FastAPI application.
---

# FastAPI Integration

Full guide for adding APoP enforcement to a FastAPI application.

## Install

```bash
pip install apop[fastapi]
```

## Project Setup

### 1. Create Your Policy

```json title="agent-policy.json"
{
  "$schema": "https://agentpolicy.org/schema/v1/agent-policy.schema.json",
  "version": "1.0",
  "policyUrl": "https://yourapi.com/.well-known/agent-policy.json",
  "defaultPolicy": {
    "allow": true,
    "actions": ["read", "api_call"],
    "disallow": ["extract", "automated_purchase"],
    "rateLimit": { "requests": 500, "window": "hour" },
    "requireVerification": false
  },
  "pathPolicies": [
    {
      "path": "/api/v1/**",
      "allow": true,
      "actions": ["api_call", "read"],
      "requireVerification": true,
      "rateLimit": { "requests": 1000, "window": "hour" }
    },
    {
      "path": "/admin/**",
      "allow": false
    }
  ]
}
```

### 2. Set Up the Application

```python title="main.py"
from fastapi import FastAPI
from apop.parser import parse_policy_file
from apop.middleware.fastapi import create_fastapi_middleware, create_discovery_route
from apop.types import MiddlewareOptions

# Initialize FastAPI
app = FastAPI(title="My API with APoP")

# Load and validate policy
result = parse_policy_file("agent-policy.json")
if not result.valid:
    raise RuntimeError(f"Invalid policy: {result.errors}")

policy = result.policy

# Add enforcement middleware
app.add_middleware(
    create_fastapi_middleware(MiddlewareOptions(policy=policy))
)

# Serve policy at well-known URL
app.get("/.well-known/agent-policy.json")(create_discovery_route(policy))


@app.get("/")
async def root():
    return {"message": "Hello, this API is protected by APoP!"}


@app.get("/api/v1/data")
async def get_data():
    return {"data": "Sensitive information, only for verified agents"}


@app.get("/api/v1/health")
async def health():
    return {"status": "ok"}
```

### 3. Run the Application

```bash
uvicorn main:app --reload
```

## Testing

```bash
# Normal request — passes through
curl http://localhost:8000/

# Agent request — allowed
curl -H "Agent-Name: MyBot/1.0" \
     -H "Agent-Intent: read" \
     http://localhost:8000/

# Verification required
curl -H "Agent-Name: MyBot/1.0" \
     -H "Agent-Intent: api_call" \
     http://localhost:8000/api/v1/data
# → 439 (needs verification)

# With verification
curl -H "Agent-Name: MyBot/1.0" \
     -H "Agent-Intent: api_call" \
     -H "Agent-Id: did:web:mybot.com" \
     -H "Agent-Signature: sig123" \
     http://localhost:8000/api/v1/data
# → 200

# Policy discovery
curl http://localhost:8000/.well-known/agent-policy.json
```

## Production Deployment

### With Gunicorn

```bash
pip install gunicorn uvicorn
gunicorn main:app -k uvicorn.workers.UvicornWorker -w 4 --bind 0.0.0.0:8000
```

### With Docker

```dockerfile title="Dockerfile"
FROM python:3.12-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

## Notes

- The middleware processes agent headers automatically — no manual header parsing needed.
- Combine with `slowapi` for actual rate limiting enforcement.
- The policy file is loaded once at startup for performance.
